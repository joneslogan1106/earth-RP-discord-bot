name: Government Date Bot

on:
  schedule:
    # Run every 25 minutes (stays under GitHub's 30-min free limit)
    - cron: '*/25 * * * *'
    
    # Midnight EST checks (covers both EST/EDT)
    - cron: '55 3 * * *'   # 23:55 EST (3:55 UTC)
    - cron: '0 4 * * *'    # 00:00 EDT (4:00 UTC) - March to November
    - cron: '5 4 * * *'    # 00:05 EDT (4:05 UTC)
    - cron: '0 5 * * *'    # 00:00 EST (5:00 UTC) - November to March
    - cron: '5 5 * * *'    # 00:05 EST (5:05 UTC)
    
  # Allow manual runs
  workflow_dispatch:

jobs:
  run-bot:
    runs-on: ubuntu-latest
    
    # Grant write permissions to the GITHUB_TOKEN
    permissions:
      contents: write
    
    steps:
    # Step 1: Checkout with write permissions
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # Get all history for proper git operations
        
    # Step 2: Setup Python
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    # Step 3: Install dependencies
    - name: Install dependencies
      run: |
        pip install discord.py python-dateutil
        echo "‚úÖ Dependencies installed"
        
    # Step 4: Show current state
    - name: Show current state
      run: |
        echo "=== CURRENT STATE ==="
        if [ -f gov_state.json ]; then
          echo "üìÑ State file exists"
          echo "üìÖ Current date:"
          grep -o '"current_date": "[^"]*"' gov_state.json || echo "  Not found"
          echo "‚è∞ Last advance:"
          grep -o '"last_advance_date": "[^"]*"' gov_state.json || echo "  Not found"
          echo "üîß Settings:"
          grep -o '"settings": {[^}]*}' gov_state.json || echo "  Not found"
        else
          echo "üìÑ No state file - will create new one"
        fi
        echo "====================="
        
    # Step 5: Run Discord Bot
    - name: Run Discord Bot
      env:
        DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
        DISCORD_CHANNEL_ID: ${{ secrets.DISCORD_CHANNEL_ID }}
      run: |
        echo "ü§ñ STARTING GOVERNMENT DATE BOT"
        echo "================================"
        echo "‚è∞ UTC Time: $(date -u)"
        echo "‚è∞ EST Time: $(TZ=America/New_York date)"
        echo "üìÖ Schedule: Runs every 25 minutes"
        echo "üïõ Auto-advance: Midnight EST daily"
        echo "üíæ Auto-save: Every 60 seconds"
        echo "================================"
        
        # Run bot for 22 minutes (leaves time for git operations)
        timeout 1320 python bot.py
        
        echo "üîÑ Run completed - will restart in next scheduled job"
        
    # Step 6: Save state changes to git (ALWAYS runs)
    - name: Save state changes
      if: always()  # Critical: Run even if previous step fails or times out
      env:
        # Use the automatically provided GITHUB_TOKEN
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "üíæ SAVING STATE CHANGES"
        echo "========================"
        
        # Configure git with proper identity
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        
        # Check if state file exists
        if [ ! -f gov_state.json ]; then
          echo "‚ùå ERROR: State file not found after bot run!"
          exit 1
        fi
        
        echo "üìÑ State file exists, checking for changes..."
        
        # Show git status
        echo "Git status:"
        git status --porcelain gov_state.json
        
        # Check if file has been modified
        if [[ -n $(git status --porcelain gov_state.json) ]]; then
          echo "‚úÖ Changes detected in state file"
          
          # Show what changed
          echo "Changes:"
          git diff --stat gov_state.json || echo "No diff available"
          
          # Stage changes
          echo "Staging changes..."
          git add gov_state.json
          
          # Commit changes
          echo "Creating commit..."
          commit_msg="ü§ñ Auto-save bot state - $(date +'%Y-%m-%d %H:%M:%S EST')"
          git commit -m "$commit_msg"
          
          # Push changes
          echo "Pushing to repository..."
          git push
          
          echo "‚úÖ State successfully saved and pushed to repository"
          echo "üìù Commit: $(git log --oneline -1)"
        else
          echo "üì≠ No changes to state file"
        fi
        
        echo "========================"
        
    # Step 7: Show final state
    - name: Show final state
      if: always()
      run: |
        echo "=== FINAL STATE ==="
        if [ -f gov_state.json ]; then
          echo "üìÑ State file preserved"
          echo "üìÖ Current date:"
          grep -o '"current_date": "[^"]*"' gov_state.json || echo "  Not found"
          echo "‚è∞ Last advance:"
          grep -o '"last_advance_date": "[^"]*"' gov_state.json || echo "  Not found"
          echo "üîß Auto-save: $(grep -q '"auto_save": true' gov_state.json && echo '‚úÖ ON' || echo '‚ùå OFF')"
          echo "üîî Notifications: $(grep -q '"notifications_enabled": true' gov_state.json && echo '‚úÖ ON' || echo '‚ùå OFF')"
        else
          echo "‚ùå ERROR: State file missing!"
        fi
        echo "==================="
