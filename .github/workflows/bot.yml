name: 24/7 Discord Bot Runner

on:
  # Run every 25 minutes (stays under 30 min limit)
  schedule:
    - cron: '*/25 * * * *'
  # Allow manual runs
  workflow_dispatch:

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 24  # Stop at 24 minutes to be safe
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        pip install discord.py python-dateutil
        echo "âœ… Dependencies installed"
        
    - name: Create state file
      run: |
        if [ ! -f gov_state.json ]; then
          echo '{"current_date": "'$(date -Iseconds)'", "last_run": "'$(date -I)'"}' > gov_state.json
        fi
        echo "ðŸ“ State file ready"
        
    - name: Run Discord Bot
      env:
        DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
        DISCORD_CHANNEL_ID: ${{ secrets.DISCORD_CHANNEL_ID }}
        ADMIN_USER_ID: 1367955172373823629
      run: |
        echo "ðŸ¤– Starting Government Bot..."
        echo "â° Will run for 24 minutes..."
        
        # Create bot.py with this content:
        cat > bot.py << 'EOF'
import discord
import os
import json
import asyncio
from datetime import datetime
from dateutil.relativedelta import relativedelta

TOKEN = os.getenv("DISCORD_TOKEN")
CHANNEL_ID = int(os.getenv("DISCORD_CHANNEL_ID", 0))
ADMIN_USER_ID = int(os.getenv("ADMIN_USER_ID", 0))
DATA_FILE = "gov_state.json"

print("ðŸ¤– Government Bot - GitHub Actions Edition")
print(f"Token present: {'âœ…' if TOKEN else 'âŒ'}")

# Load state
def load_state():
    try:
        with open(DATA_FILE, "r") as f:
            return json.load(f)
    except:
        now = datetime.now()
        return {"current_date": now.isoformat(), "last_run": now.date().isoformat()}

def save_state(state):
    with open(DATA_FILE, "w") as f:
        json.dump(state, f, indent=2)

state = load_state()

# Discord bot
intents = discord.Intents.default()
intents.message_content = True

class GitHubBot(discord.Client):
    async def on_ready(self):
        print(f"âœ… Connected as {self.user}")
        await self.change_presence(activity=discord.Activity(
            type=discord.ActivityType.watching,
            name="GitHub Actions | !date"
        ))
        
    async def on_message(self, message):
        if message.author.bot:
            return
            
        print(f"[MSG] {message.author}: {message.content}")
        
        if message.content == "!date":
            current = datetime.fromisoformat(state["current_date"])
            await message.channel.send(f"ðŸ“… **Current date:** {current.strftime('%B %Y')}")
            
        elif message.content == "!advance":
            if message.author.id != ADMIN_USER_ID:
                await message.channel.send("âŒ Not authorized")
                return
                
            current = datetime.fromisoformat(state["current_date"])
            new_date = current + relativedelta(months=4)
            state["current_date"] = new_date.isoformat()
            state["last_run"] = datetime.now().date().isoformat()
            save_state(state)
            
            await message.channel.send(f"âš™ï¸ **Advanced to:** {new_date.strftime('%B %Y')}")
            
        elif message.content == "!ping":
            await message.channel.send("ðŸ“ Pong from GitHub Actions! (24/7 Free)")
            
        elif message.content == "!status":
            await message.channel.send("âœ… Bot running on GitHub Actions\nâ° Free 24/7 hosting\nðŸ”„ Restarts every 25 minutes")

# Run bot
bot = GitHubBot(intents=intents)
bot.run(TOKEN)
EOF
        
        # Run for 24 minutes
        timeout 24m python bot.py || true
        echo "ðŸ”„ Restarting in next workflow run..."
        
    - name: Save state file
      run: |
        echo "ðŸ’¾ Saving state for next run..."
        git config --global user.email "actions@github.com"
        git config --global user.name "GitHub Actions"
        git add gov_state.json
        git commit -m "Update bot state" || echo "No changes to commit"
        git push || echo "Nothing to push"
